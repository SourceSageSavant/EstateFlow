
# Project Name: EstateFlow (PWA)

**Type:** Progressive Web Application (PWA)
**Primary Goal:** To manage rental properties, tenant interactions, payments, and gate security via a unified, installable web application.

---

## 1. The Tech Stack (Selected for Speed & Scalability)

We are choosing a "Serverless" architecture. This keeps costs low (often free for the first 500 users) and performance high.

| Component | Technology | Why this choice? |
| --- | --- | --- |
| **Frontend Framework** | **Next.js (React)** | The industry standard for PWAs. Excellent performance, SEO-friendly, and huge community support. |
| **Styling** | **Tailwind CSS** | "Utility-first" CSS. Makes building mobile-responsive layouts (critical for the Guard/Tenant views) extremely fast. |
| **Database & Auth** | **Supabase** | (Your Requirement) Open-source Firebase alternative. Gives us a real PostgreSQL database, Authentication, and file storage out of the box. |
| **State Management** | **Zustand** | Lighter and easier than Redux. Perfect for managing "offline" state in a PWA. |
| **Icons** | **Lucide React** | Clean, modern icons for the dashboard interface. |
| **Deployment** | **Vercel** | The creators of Next.js. Deploying the PWA here takes one click. |
| **Payment Processor** | **Paystack or Daraja API** | Essential for Mobile Money (M-Pesa) integration in your region. |

---

## 2. User Roles & Permission Matrix

The system relies on **Role-Based Access Control (RBAC)**.

### **A. Landlord (Admin)**

* **Privileges:** Full access (God Mode).
* **Key Capabilities:** Add/Remove units, view all financial data, add Guards, audit security logs, approve maintenance.

### **B. Tenant**

* **Privileges:** Read/Write access to *own* data only.
* **Key Capabilities:** View own lease, pay rent, generate Visitor Codes, report maintenance issues.
* **Restriction:** Cannot see other tenants or building financials.

### **C. Guard**

* **Privileges:** Read-only access to "Visitor List"; Write access to "Visitor Logs".
* **Key Capabilities:** Verify visitor codes, log manual entries, view "Banned Visitors" list.
* **Restriction:** Cannot see tenant rent status, lease details, or phone numbers (privacy protection).

---

## 3. Database Schema (Supabase / PostgreSQL)

This is the most critical part. We will use Supabase's relational database features.

### **Table 1: `profiles**` (Extends the default Auth User)

* `id` (UUID, PK) - Links to Supabase Auth
* `role` (Enum) - 'landlord', 'tenant', 'guard'
* `full_name` (Text)
* `phone_number` (Text)
* `avatar_url` (Text)
* `created_at` (Timestamp)

### **Table 2: `properties**` (The Buildings)

* `id` (UUID, PK)
* `name` (Text) - e.g., "Sunset Apartments"
* `address` (Text)
* `total_units` (Int)

### **Table 3: `units**` (The Apartments)

* `id` (UUID, PK)
* `property_id` (FK)
* `unit_number` (Text) - e.g., "A4" or "Penthouse"
* `current_tenant_id` (UUID, FK -> profiles) - Nullable if empty
* `rent_amount` (Numeric)
* `status` (Enum) - 'occupied', 'vacant', 'maintenance'

### **Table 4: `gate_passes**` (The Security Core)

* `id` (UUID, PK)
* `tenant_id` (FK -> profiles) - Who invited them
* `visitor_name` (Text) - Optional
* `access_code` (Text) - **Unique 6-digit code** (Generated by system)
* `status` (Enum) - 'active', 'used', 'expired', 'revoked'
* `valid_until` (Timestamp) - Usually set to 24 hours
* `entry_time` (Timestamp) - Filled when Guard scans
* `guard_id` (FK -> profiles) - Which guard cleared them

### **Table 5: `maintenance_requests**`

* `id` (UUID, PK)
* `tenant_id` (FK)
* `unit_id` (FK)
* `category` (Enum) - 'plumbing', 'electrical', 'other'
* `description` (Text)
* `photo_url` (Text)
* `status` (Enum) - 'pending', 'scheduled', 'completed'

### **Table 6: `payments**`

* `id` (UUID, PK)
* `tenant_id` (FK)
* `amount` (Numeric)
* `transaction_ref` (Text) - M-Pesa/Bank reference
* `status` (Enum) - 'verified', 'pending', 'failed'
* `month_paid_for` (Date)

---

## 4. Key Workflows & Logic

### **A. The "Gate Pass" Logic (Security)**

1. **Tenant Action:** Clicks "New Visitor".
2. **System Action:** Generates a random 6-digit code (e.g., `884-219`). Saves to `gate_passes` table with `status = active`.
3. **Guard Action:** Types `884-219` into their PWA.
4. **System Check:**
* Does code exist?
* Is `status == active`?
* Is `valid_until > now()`?


5. **Result:** If YES, System updates `status` to `used`, logs `entry_time`, and returns **"âœ… ALLOWED: Guest for Unit A4"**.

### **B. The Payment Logic**

1. **Tenant Action:** Enters amount and phone number -> Clicks "Pay with M-Pesa".
2. **System Action:** Calls Payment API (Paystack/Daraja) triggers STK Push to tenant's phone.
3. **Webhook:** When payment succeeds, the Payment Provider sends a signal to Supabase.
4. **Database Trigger:** A Supabase Function listens for the payment, matches the ID, and marks the tenant's rent as "PAID" for the month.

---

## 5. Security & Row Level Security (RLS)

Since we are using Supabase, we **must** write RLS policies. This ensures that even if someone hacks the frontend, they cannot steal data.

* **Policy 1 (Tenants):** `SELECT * FROM units WHERE current_tenant_id = auth.uid()`
* *Translation:* Tenants can only see the unit they live in.


* **Policy 2 (Guards):** `SELECT * FROM gate_passes WHERE status = 'active'`
* *Translation:* Guards can only verify active passes, they cannot browse old history of who visited whom (privacy).


* **Policy 3 (Landlord):** `SELECT * FROM all_tables`
* *Translation:* Landlord sees everything.



---

## 6. The PWA Implementation (How to make it an App)

To ensure this works perfectly on Android and iOS without an app store:

1. **The Manifest File (`manifest.json`):**
* **Name:** "MyEstate"
* **Display:** `standalone` (Removes the browser URL bar so it looks like an app).
* **Theme Color:** Your brand color (e.g., Navy Blue).


2. **Service Worker:**
* We will use `next-pwa` plugin.
* **Caching Strategy:** "NetworkFirst". It tries to get live data. If internet fails, it serves the cached Dashboard so the screen isn't blank.



---

## 7. Development Roadmap

**Phase 1: The Foundation (Week 1-2)**

* Set up Next.js project.
* Connect Supabase.
* Build Login/Sign-up pages.
* Create the `profiles` and `units` tables.

**Phase 2: The Landlord & Tenant Core (Week 3-4)**

* Build Landlord Dashboard (Add units/tenants).
* Build Tenant Dashboard (View rent status).
* Implement Payment integration.

**Phase 3: The Security Module (Week 5)**

* Build the Guard Interface (Big buttons, high contrast).
* Implement the Gate Pass logic.

**Phase 4: PWA & Polish (Week 6)**

* Add icons and splash screens.
* Test "Add to Home Screen" on iPhone and Android.
* Test offline capabilities.
